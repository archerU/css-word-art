// const json = {
//   "moduleId": '10166-01',
//   "name": "女装模版01",
//   "canvas": {
//     "width": 700,
//     "height": 1000
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "60px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "水洗超高腰",
//         "fillStyle": '#FCE370',
//         "textAlign": 'left',
//         "position": {
//           "left": "108",
//           "top": "400"
//         },
//         "effects": [
//           {
//             "strokeStyle": '#000000',
//             "lineWidth": 4
//           }
//         ]
//       }
//     ],
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 700,
//     "height": 1000
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "60px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "迷你自动白色",
//         "fillStyle": '#FFFFFF',
//         "textAlign": 'left',
//         "position": {
//           "left": "108",
//           "top": "400"
//         },
//         "effects": [
//           {
//             "strokeStyle": '#000000',
//             "lineWidth": 6
//           }
//         ]
//       },
//       {
//         "text": "生活电器",
//         "fillStyle": '#000000',
//         "effects": [
//           {
//             "strokeStyle": '#FFFFFF',
//             "lineWidth": 6
//           }
//         ]
//       }
//     ],
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "92px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "通勤风长袖条纹",
//         "fillStyle": '#BEFE1F',
//         "textAlign": 'center',
//         "shadowOffsetX": 3,
//         "shadowOffsetY": 2,
//         "shadowBlur": 0,
//         "shadowColor": '#000000',
//         "position": {
//           "left": "0",
//           "right": "0",
//           "top": "530"
//         }
//       },
//       {
//         "text": "生活电器"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#000000',
//         "lineWidth": 4
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "92px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "OL风两件套",
//         "fillStyle": '#FFFFFF',
//         "textAlign": 'right',
//         "shadowOffsetX": 5,
//         "shadowOffsetY": 4,
//         "shadowBlur": 0,
//         "shadowColor": '#6D92FF',
//         "position": {
//           "right": "58",
//           "top": "430"
//         }
//       },
//       {
//         "text": "职业装"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#0546FF',
//         "lineWidth": 4
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "闭眼入显瘦超高",
//         "fillStyle": '#FFFFFF',
//         "textAlign": 'center',
//         "shadowOffsetX": 5,
//         "shadowOffsetY": 4,
//         "shadowBlur": 0,
//         "shadowColor": '#FFB1B0',
//         "position": {
//           "top": 160,
//           "left": 0,
//           "right": 0
//         },
//       },
//       {
//         "text": "腰直筒九分裤"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#8523E8',
//         "lineWidth": 3
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "中筒透气纯色",
//         "fillStyle": '#ffffff',
//         "textAlign": 'right',
//         "shadowOffsetX": 5,
//         "shadowOffsetY": 4,
//         "shadowBlur": 0,
//         "shadowColor": '#000000',
//         "position": {
//           "top": 170,
//           "right": 60
//         },
//       },
//       {
//         "text": "纯棉袜子"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#000000',
//         "lineWidth": 3
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "男式中腰薄款",
//         "fillStyle": '#000000',
//         "textAlign": 'left',
//         "position": {
//           "top": 170,
//           "left": 60
//         },
//       },
//       {
//         "text": "工装收口牛仔裤"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#FFFFFF',
//         "lineWidth": 4
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "彩虹日韩风发夹",
//         "fillStyle": '#FCEC76',
//         "textAlign": 'center',
//         "position": {
//           "right": 0,
//           "left": 0,
//           "top": 620,
//         },
//       },
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#000000',
//         "lineWidth": 2
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "日系磨砂",
//         "fillStyle": '#9A0606',
//         "textAlign": 'center',
//         "position": {
//           "right": 0,
//           "left": 0,
//           "top": 150,
//         },
//       },
//       {
//         "text": "",
//         "fillStyle": '#9A0606',
//         "textAlign": 'center',
//         "position": {
//           "right": 0,
//           "left": 0,
//           "top": 620,
//         },
//       },
//     ],
//     "effects": [
//       {
//         "strokeStyle": '#FFFFFF',
//         "lineWidth": 6
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "82px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "无香浓缩低泡",
//         "fillStyle": "#F07160",
//         "textAlign": "left",
//         "shadowOffsetX": 2,
//         "shadowOffsetY": 2,
//         "shadowBlur": 7,
//         "shadowColor": "#6A6A6A",
//         "position": {
//           "left": 75,
//           "top": 500
//         }
//       },
//       {
//         "text": "易漂凝珠",
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": "#FFFFFF",
//         "lineWidth": 6
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "女中大童韩版",
//         "fillStyle": "#FFFFFF",
//         "textAlign": "center",
//         "shadowOffsetX": 4,
//         "shadowOffsetY": 2,
//         "shadowBlur": 0,
//         "shadowColor": "#FF2342",
//         "position": {
//           "right": 0,
//           "left": 0,
//           "top": 360
//         }
//       },
//       {
//         "text": "棉裤套装",
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": "#000000",
//         "lineWidth": 2
//       }
//     ]
//   }
// }


// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "铝框金属防水",
//         "fillStyle": "#29498B",
//         "textAlign": "right",
//         "shadowOffsetX": 3,
//         "shadowOffsetY": 1,
//         "shadowBlur": 7,
//         "shadowColor": "#F8BF91",
//         "position": {
//           "right": 56,
//           "top": 180
//         }
//       },{
//         "text": "旅行包"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": "#FFFFFF",
//         "lineWidth": 4
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "液晶充电",
//         "fillStyle": "#085E70",
//         "textAlign": "right",
//         "shadowOffsetX": 4,
//         "shadowOffsetY": 3,
//         "shadowBlur": 3,
//         "shadowColor": "#F7EE59",
//         "position": {
//           "right": 56,
//           "top": 500
//         }
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": "#FFFFFF",
//         "lineWidth": 4
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "迷你自动白色",
//         "fillStyle": "#FFFFFF",
//         "textAlign": "left",
//         "position": {
//           "left": 70,
//           "top": 145
//         },
//         "effects": [
//           {
//             "strokeStyle": "#000000",
//             "lineWidth": 6
//           }
//         ]
//       },
//       {
//         "text": "生活电器",
//         "fillStyle": "#000000",
//         "effects": [
//           {
//             "strokeStyle": "#FFFFFF",
//             "lineWidth": 6
//           }
//         ]
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "迷你自动白色",
//         "fillStyle": "#FFFFFF",
//         "textAlign": "left",
//         "position": {
//           "left": 70,
//           "top": 145
//         },
//         "effects": [
//           {
//             "strokeStyle": "#000000",
//             "lineWidth": 6
//           }
//         ]
//       },
//       {
//         "text": "生活电器",
//         "fillStyle": "#000000",
//         "effects": [
//           {
//             "strokeStyle": "#FFFFFF",
//             "lineWidth": 6
//           }
//         ]
//       }
//     ]
//   }
// }

// const json = {
//   "moduleId": 'default',
//   "name": "默认模版",
//   "canvas": {
//     "width": 696,
//     "height": 880
//   },
//   "config": {
//     "font": {
//       "fontStyle": "normal",
//       "fontWeight": 900,
//       "fontSize": "80px",
//       "fontFamily": "SimSun, Songti SC"
//     },
//     "contents": [
//       {
//         "text": "送装入户",
//         "fillStyle": "#000000",
//         "textAlign": "center",
//         "position": {
//           "left": 0,
//           "right": 0,
//           "top": 150
//         }
//       },
//       {
//         "text": "家用实木r架"
//       }
//     ],
//     "effects": [
//       {
//         "strokeStyle": "#ffffff",
//         "lineWidth": 4
//       }
//     ]
//   }
// }

const json = {
  "moduleId": 'default',
  "name": "默认模版",
  "canvas": {
    "width": 696,
    "height": 880
  },
  "config": {
    "font": {
      "fontStyle": "normal",
      "fontWeight": 900,
      "fontSize": "80px",
      "fontFamily": "SimSun, Songti SC"
    },
    "contents": [
      {
        "text": "北欧卧室",
        "fillStyle": "#FFFFFF",
        "textAlign": "center",
        "shadowOffsetX": 4,
        "shadowOffsetY": 2,
        "shadowBlur": 10,
        "shadowColor": "#1343DB",
        "position": {
          "left": 0,
          "right": 0,
          "top": 550
        }
      }
    ],
    "effects": [
      {
        "strokeStyle": "#1343DB",
        "lineWidth": 2
      }
    ]
  }
}

function parseJsonToCanvas(json) {
  const canvas = document.querySelector('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = json.canvas.width;
  canvas.height = json.canvas.height;

  ctx.x = json.position && json.position.left || canvas.width/2;
  ctx.y = json.position && json.position.top || canvas.height/2;

  // 渲染默认字体大小
  ctx.font = json.config.font && Object.values(json.config.font).join(" ");
  ctx.fontSize = json.config.font && json.config.font.fontSize && parseInt(json.config.font.fontSize, 10);

  json.config.contents.forEach((item, index) => {
    Object.keys(item).forEach(key => {
      item[key] ? ctx[key] = item[key] : '';
    });
    const text = item.text;
    const _textZh = ctx.measureText(item.text);
    ctx.textBaseline = item.textBaseline || 'top'; 
    ctx.lineHeight = item.lineHeight ? parseInt(item.lineHeight, 10) : 10;
    if(item.textAlign) {
      ctx.textAlign = item.textAlign
    }

    //x 轴设置,  left,right 同时存在为居中，不设置position: left/right 则默认居中。优先级：right > left > center
    if(item.position && item.position.left && item.position.right) {
      if (item.textAlign === 'left') {
        ctx.x = canvas.width/2 - _textZh.width/2;
      }
      if (item.textAlign === 'right') {
        ctx.x = canvas.width/2 + _textZh.width/2;
      }
      if (item.textAlign === 'center') {
        ctx.x = canvas.width/2
      }
    } else if (item.position && item.position.right) {
      ctx.x = canvas.width - (parseInt(item.position.right, 10) * canvas.width / Number(json.canvas.width));
    } else if(item.position && item.position.left) {
      ctx.x = parseInt(item.position.left, 10) * canvas.width / Number(json.canvas.width);
    }

    // y 轴设置
    if(item.position && item.position.top) {
      ctx.y = canvas.height * Number(item.position.top) / Number(json.canvas.height);
    }

    // 渲染描边
    let effects;
    if (item.effects) {
      effects = item.effects;
    } else if (json.config.effects) {
      effects = json.config.effects
    }
    effects.forEach((effect) => {
      if (effect.strokeStyle) {
        ctx.strokeStyle = effect.strokeStyle;
      }
      if (effect.gradient && effect.gradient.length > 0) {
        const _strokeStyle = renderLinearGradient(text, effect.gradient, ctx);
        ctx.strokeStyle = _strokeStyle;
      }
      
      ctx.lineWidth = effect.lineWidth;
      ctx.strokeText(text, ctx.x, Number(ctx.y)+ index*(ctx.fontSize + ctx.lineHeight));
    });
   
   
    // 渲染文字
    ctx.fillText(item.text, ctx.x, Number(ctx.y)+ index*(ctx.fontSize + ctx.lineHeight));
  });
}

function renderLinearGradient(text, gradient, ctx) {
  const text_width = ctx.measureText(text);
  const _gradient = ctx.createLinearGradient(0,0,text_width.width,0);
  gradient.forEach(y => {
    Object.entries(y).forEach(u => {
      _gradient.addColorStop(u[0],u[1]);
    });
  });
  return _gradient;
}
parseJsonToCanvas(json);

